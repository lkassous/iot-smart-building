# GitHub Actions CI/CD Pipeline
# IoT Smart Building - Tests, Linting, et Build Docker

name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: "3.11"
  DOCKER_BUILDKIT: 1

jobs:
  # ============================================
  # Job 1: Linting et vÃ©rification du code
  # ============================================
  lint:
    name: ðŸ” Linting Python
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ðŸ“¦ Installation des dÃ©pendances linting
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort
      
      - name: ðŸ”Ž VÃ©rification avec Flake8
        run: |
          cd webapp
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      
      - name: ðŸŽ¨ VÃ©rification formatage avec Black
        run: |
          cd webapp
          black --check --diff . || echo "Warning: Code formatting issues detected"
      
      - name: ðŸ“‹ VÃ©rification imports avec isort
        run: |
          cd webapp
          isort --check-only --diff . || echo "Warning: Import ordering issues detected"

  # ============================================
  # Job 2: Tests unitaires
  # ============================================
  test:
    name: ðŸ§ª Tests Unitaires
    runs-on: ubuntu-latest
    needs: lint
    
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: admin123
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ping:1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7.2-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ðŸ“¦ Installation des dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r webapp/requirements.txt
          pip install pytest pytest-cov pytest-flask
      
      - name: ðŸ§ª ExÃ©cution des tests unitaires
        working-directory: webapp
        env:
          MONGODB_URI: mongodb://admin:admin123@localhost:27017/iot_test?authSource=admin
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          ELASTICSEARCH_HOST: http://localhost:9200
          FLASK_ENV: testing
          SECRET_KEY: test-secret-key
        run: |
          pytest tests/ -v --tb=short --cov=. --cov-report=xml --cov-report=term
      
      - name: ðŸ“Š Upload coverage vers Codecov
        uses: codecov/codecov-action@v4
        with:
          file: webapp/coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # ============================================
  # Job 3: Tests d'intÃ©gration avec Docker Compose
  # ============================================
  integration:
    name: ðŸ”— Tests IntÃ©gration
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ðŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ðŸ—ï¸ Build et dÃ©marrage des services
        run: |
          docker compose build webapp
          docker compose up -d elasticsearch mongodb redis
          sleep 30  # Attendre que les services dÃ©marrent
      
      - name: ðŸ” VÃ©rification santÃ© Elasticsearch
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:9200/_cluster/health | grep -q '"status":"green\|yellow"'; then
              echo "âœ… Elasticsearch est prÃªt"
              break
            fi
            echo "â³ Attente Elasticsearch... ($i/30)"
            sleep 5
          done
      
      - name: ðŸ” VÃ©rification santÃ© MongoDB
        run: |
          docker compose exec -T mongodb mongosh --eval "db.runCommand({ping:1})" || true
      
      - name: ðŸš€ DÃ©marrage webapp
        run: |
          docker compose up -d webapp
          sleep 10
      
      - name: ðŸ§ª Tests de santÃ© API
        run: |
          # VÃ©rifier la page d'accueil
          curl -f http://localhost:8000/health || echo "Health check failed"
          
          # VÃ©rifier l'API stats
          curl -f http://localhost:8000/api/v1/stats || echo "API stats failed"
          
          # VÃ©rifier la page alerts
          curl -f http://localhost:8000/alerts/ || echo "Alerts page failed"
      
      - name: ðŸ“‹ Logs des services en cas d'Ã©chec
        if: failure()
        run: |
          docker compose logs webapp
          docker compose logs elasticsearch
      
      - name: ðŸ§¹ Nettoyage
        if: always()
        run: docker compose down -v

  # ============================================
  # Job 4: Build image Docker
  # ============================================
  build:
    name: ðŸ³ Build Docker Image
    runs-on: ubuntu-latest
    needs: [test, integration]
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ðŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ðŸ—ï¸ Build webapp image
        uses: docker/build-push-action@v5
        with:
          context: ./webapp
          push: false
          tags: iot-smart-building/webapp:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: ðŸ“Š RÃ©sumÃ© du build
        run: |
          echo "### ðŸŽ‰ Build rÃ©ussi!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: iot-smart-building/webapp:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Job 5: SÃ©curitÃ© (optionnel)
  # ============================================
  security:
    name: ðŸ”’ Scan SÃ©curitÃ©
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ðŸ“¦ Installation des outils de sÃ©curitÃ©
        run: |
          pip install safety bandit
      
      - name: ðŸ” VÃ©rification des dÃ©pendances avec Safety
        run: |
          pip install -r webapp/requirements.txt
          safety check --json || echo "Warning: Vulnerabilities detected"
      
      - name: ðŸ” Analyse statique avec Bandit
        run: |
          cd webapp
          bandit -r . -ll -ii -x tests/ || echo "Warning: Security issues detected"

  # ============================================
  # Job 6: Notification (optionnel)
  # ============================================
  notify:
    name: ðŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [build]
    if: always()
    
    steps:
      - name: ðŸ“Š RÃ©sumÃ© du workflow
        run: |
          echo "### ðŸ“Š RÃ©sumÃ© CI/CD Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration | ${{ needs.integration.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
