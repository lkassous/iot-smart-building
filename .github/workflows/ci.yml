# GitHub Actions CI/CD Pipeline
# IoT Smart Building - Pipeline complet avec dÃ©ploiement

name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# Permissions globales pour GITHUB_TOKEN
permissions:
  contents: read
  packages: write
  actions: read

env:
  PYTHON_VERSION: "3.11"
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================
  # Ã‰tape 1: Linting (flake8, pylint)
  # ============================================
  linting:
    name: ðŸ” Linting (flake8, pylint)
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ðŸ“¦ Installation des outils de linting
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint black isort
          pip install -r webapp/requirements.txt
      
      - name: ðŸ”Ž Linting avec Flake8
        run: |
          cd webapp
          echo "### ðŸ” RÃ©sultats Flake8" >> $GITHUB_STEP_SUMMARY
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
          echo "âœ… Flake8 terminÃ©" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ”Ž Linting avec Pylint
        run: |
          cd webapp
          echo "### ðŸ” RÃ©sultats Pylint" >> $GITHUB_STEP_SUMMARY
          pylint --exit-zero --output-format=text app.py config.py 2>/dev/null | tail -5 || true
          echo "âœ… Pylint terminÃ©" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸŽ¨ VÃ©rification formatage Black
        run: |
          cd webapp
          black --check --diff . || echo "âš ï¸ Formatage Black: corrections suggÃ©rÃ©es"
      
      - name: ðŸ“‹ VÃ©rification imports isort
        run: |
          cd webapp
          isort --check-only --diff . || echo "âš ï¸ Imports isort: corrections suggÃ©rÃ©es"

  # ============================================
  # Ã‰tape 2: Tests Unitaires
  # ============================================
  tests-unitaires:
    name: ðŸ§ª Tests Unitaires
    runs-on: ubuntu-latest
    needs: linting
    
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: admin123
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ping:1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7.2-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ðŸ“¦ Installation des dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r webapp/requirements.txt
          pip install pytest pytest-cov pytest-flask
      
      - name: ðŸ§ª ExÃ©cution des tests unitaires
        working-directory: webapp
        env:
          MONGODB_URI: mongodb://admin:admin123@localhost:27017/iot_test?authSource=admin
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          ELASTICSEARCH_HOST: http://localhost:9200
          FLASK_ENV: testing
          SECRET_KEY: test-secret-key-ci-cd
        run: |
          pytest tests/ -v \
            --tb=short \
            --cov=. \
            --cov-report=xml \
            --cov-report=term-missing \
            --junitxml=test-results.xml
      
      - name: ðŸ“Š Rapport de couverture
        run: |
          echo "### ðŸ§ª RÃ©sultats Tests Unitaires" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Tests exÃ©cutÃ©s avec succÃ¨s" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ“¤ Upload coverage vers Codecov
        uses: codecov/codecov-action@v4
        with:
          file: webapp/coverage.xml
          flags: unittests
          name: codecov-iot-smart-building
          fail_ci_if_error: false
      
      - name: ðŸ“¤ Upload artifacts tests
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            webapp/coverage.xml
            webapp/test-results.xml

  # ============================================
  # Ã‰tape 3: Tests d'IntÃ©gration
  # ============================================
  tests-integration:
    name: ðŸ”— Tests d'IntÃ©gration
    runs-on: ubuntu-latest
    needs: tests-unitaires
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ðŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ðŸ—ï¸ Build des images Docker
        run: |
          docker compose build webapp
      
      - name: ðŸš€ DÃ©marrage stack complÃ¨te
        run: |
          docker compose up -d
          echo "â³ Attente du dÃ©marrage des services..."
          sleep 60
      
      - name: ðŸ” VÃ©rification Elasticsearch
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:9200/_cluster/health | grep -q '"status"'; then
              echo "âœ… Elasticsearch prÃªt"
              break
            fi
            echo "â³ Attente Elasticsearch... ($i/30)"
            sleep 5
          done
      
      - name: ðŸ” VÃ©rification Services
        run: |
          echo "VÃ©rification MongoDB..."
          docker compose exec -T mongodb mongosh -u admin -p admin123 --authenticationDatabase admin --eval "db.runCommand({ping:1})" || true
          echo "VÃ©rification Redis..."
          docker compose exec -T redis redis-cli ping || true
      
      - name: ðŸ§ª Tests d'intÃ©gration API
        run: |
          echo "### ðŸ”— Tests d'IntÃ©gration" >> $GITHUB_STEP_SUMMARY
          
          # Test Health endpoint
          curl -sf http://localhost:8000/health && echo "âœ… /health OK" >> $GITHUB_STEP_SUMMARY || echo "âŒ /health FAILED" >> $GITHUB_STEP_SUMMARY
          
          # Test API Stats
          curl -sf http://localhost:8000/api/v1/stats && echo "âœ… /api/v1/stats OK" >> $GITHUB_STEP_SUMMARY || echo "âŒ /api/v1/stats FAILED" >> $GITHUB_STEP_SUMMARY
          
          # Test pages principales
          curl -sf http://localhost:8000/ > /dev/null && echo "âœ… Page accueil OK" >> $GITHUB_STEP_SUMMARY || true
          curl -sf http://localhost:8000/search > /dev/null && echo "âœ… Page recherche OK" >> $GITHUB_STEP_SUMMARY || true
          curl -sf http://localhost:8000/upload > /dev/null && echo "âœ… Page upload OK" >> $GITHUB_STEP_SUMMARY || true
          
          echo "ðŸŽ‰ Tests d'intÃ©gration terminÃ©s" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ“‹ Logs en cas d'Ã©chec
        if: failure()
        run: |
          docker compose logs webapp --tail=100
          docker compose logs elasticsearch --tail=50
      
      - name: ðŸ§¹ Nettoyage
        if: always()
        run: docker compose down -v

  # ============================================
  # Ã‰tape 4: Build de l'image Docker
  # ============================================
  build-docker:
    name: ðŸ³ Build Image Docker
    runs-on: ubuntu-latest
    needs: tests-integration
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ðŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ðŸ·ï¸ Extraction mÃ©tadonnÃ©es Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=sha-
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
      
      - name: ðŸ” Login GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ—ï¸ Build image Docker
        uses: docker/build-push-action@v5
        with:
          context: ./webapp
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/webapp-image.tar
      
      - name: ðŸ“¤ Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: webapp-docker-image
          path: /tmp/webapp-image.tar
          retention-days: 1
      
      - name: ðŸ“Š RÃ©sumÃ© Build
        run: |
          echo "### ðŸ³ Build Docker" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Image construite avec succÃ¨s" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ·ï¸ Tags: ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Ã‰tape 5: Push vers Registry
  # ============================================
  push-registry:
    name: ðŸ“¦ Push vers Registry
    runs-on: ubuntu-latest
    needs: build-docker
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ðŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ðŸ” Login GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ·ï¸ Extraction mÃ©tadonnÃ©es
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=sha,prefix=sha-
            type=raw,value=v1.0.${{ github.run_number }}
      
      - name: ðŸ“¤ Push vers GitHub Container Registry
        uses: docker/build-push-action@v5
        with:
          context: ./webapp
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: ðŸ“Š RÃ©sumÃ© Push
        run: |
          echo "### ðŸ“¦ Image pushÃ©e vers Registry" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ³ **Registry**: ghcr.io" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Image**: ghcr.io/${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ·ï¸ **Version**: v1.0.${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Ã‰tape 6: DÃ©ploiement Automatique (Staging)
  # ============================================
  deploy-staging:
    name: ðŸš€ DÃ©ploiement Staging
    runs-on: ubuntu-latest
    needs: push-registry
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: staging
      url: https://staging.iot-smart-building.example.com
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ðŸš€ DÃ©ploiement sur environnement Staging
        run: |
          echo "### ðŸš€ DÃ©ploiement Staging" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… **Date**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”– **Version**: v1.0.${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘¤ **DÃ©ployÃ© par**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Commandes de dÃ©ploiement (simulation)
          echo "ðŸ”„ Pulling image: ghcr.io/${{ github.repository }}:latest"
          echo "ðŸ”„ ArrÃªt des anciens conteneurs..."
          echo "ðŸš€ DÃ©marrage des nouveaux conteneurs..."
          echo "âœ… VÃ©rification de santÃ©..."
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **DÃ©ploiement staging rÃ©ussi!**" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **URL**: https://staging.iot-smart-building.example.com" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ”” Notification de dÃ©ploiement
        run: |
          echo "ðŸ“¢ DÃ©ploiement staging terminÃ© avec succÃ¨s"
          echo "Version: v1.0.${{ github.run_number }}"

  # ============================================
  # RÃ©sumÃ© Final du Pipeline
  # ============================================
  pipeline-summary:
    name: ðŸ“Š RÃ©sumÃ© Pipeline
    runs-on: ubuntu-latest
    needs: [linting, tests-unitaires, tests-integration, build-docker]
    if: always()
    
    steps:
      - name: ðŸ“Š GÃ©nÃ©ration du rÃ©sumÃ© final
        run: |
          echo "# ðŸ“Š RÃ©sumÃ© CI/CD Pipeline IoT Smart Building" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Statut des Ã©tapes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Ã‰tape | Description | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1ï¸âƒ£ Linting | flake8, pylint, black, isort | ${{ needs.linting.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2ï¸âƒ£ Tests Unitaires | pytest + coverage | ${{ needs.tests-unitaires.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3ï¸âƒ£ Tests IntÃ©gration | Docker Compose stack | ${{ needs.tests-integration.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 4ï¸âƒ£ Build Docker | Image webapp | ${{ needs.build-docker.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 5ï¸âƒ£ Push Registry | ghcr.io | ðŸ”„ Sur main uniquement |" >> $GITHUB_STEP_SUMMARY
          echo "| 6ï¸âƒ£ Deploy Staging | Auto-dÃ©ploiement | ðŸ”„ Sur main uniquement |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… **ExÃ©cutÃ© le**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ¿ **Branche**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”– **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘¤ **Auteur**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
