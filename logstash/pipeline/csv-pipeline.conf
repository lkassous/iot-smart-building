input {
  file {
    path => "/usr/share/logstash/uploads/*.csv"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    file_completed_action => "log"
    file_completed_log_path => "/usr/share/logstash/completed.log"
    codec => plain {
      charset => "UTF-8"
    }
    tags => ["csv", "iot", "sensors"]
  }
}

filter {
  # Parser le CSV
  csv {
    separator => ","
    columns => ["timestamp", "zone", "sensor_type", "sensor_id", "value", "unit", "status"]
    skip_header => true
  }

  # Convertir le timestamp
  date {
    match => ["timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss", "dd/MM/yyyy HH:mm:ss"]
    target => "@timestamp"
  }

  # Convertir les types de données
  mutate {
    convert => {
      "value" => "float"
      "sensor_id" => "integer"
    }
    strip => ["zone", "sensor_type", "unit", "status"]
  }

  # Ajouter des métadonnées
  mutate {
    add_field => {
      "source_type" => "csv"
      "building" => "Smart Building A"
    }
  }

  # Créer un ID unique
  fingerprint {
    source => ["timestamp", "zone", "sensor_id"]
    target => "[@metadata][fingerprint]"
    method => "SHA256"
  }

  # Détection d'anomalies (exemple simple)
  if [sensor_type] == "temperature" {
    if [value] > 30 or [value] < 15 {
      mutate {
        add_tag => ["anomaly", "temperature_alert"]
        add_field => { "alert_level" => "warning" }
      }
    }
  }

  if [sensor_type] == "humidity" {
    if [value] > 80 or [value] < 30 {
      mutate {
        add_tag => ["anomaly", "humidity_alert"]
        add_field => { "alert_level" => "warning" }
      }
    }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "logs-iot-sensors-%{+YYYY.MM.dd}"
    document_id => "%{[@metadata][fingerprint]}"
    action => "create"
  }

  # Pour le debugging
  stdout {
    codec => rubydebug
  }
}
