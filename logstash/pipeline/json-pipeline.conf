input {
  file {
    path => "/usr/share/logstash/uploads/*.json"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => "json"
    tags => ["json", "iot", "alerts"]
  }
}

filter {
  # Parser le JSON si nécessaire
  if [message] {
    json {
      source => "message"
    }
  }

  # Convertir le timestamp
  date {
    match => ["timestamp", "ISO8601", "UNIX", "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'"]
    target => "@timestamp"
  }

  # Normaliser les champs
  mutate {
    rename => {
      "sensor" => "sensor_id"
      "location" => "zone"
      "alert_type" => "event_type"
    }
    add_field => {
      "source_type" => "json"
      "building" => "Smart Building A"
    }
  }

  # Déterminer la sévérité
  if [severity] == "critical" or [severity] == "CRITICAL" {
    mutate {
      add_tag => ["critical_alert"]
      update => { "alert_level" => "critical" }
    }
  } else if [severity] == "high" or [severity] == "HIGH" {
    mutate {
      add_tag => ["high_alert"]
      update => { "alert_level" => "high" }
    }
  }

  # Enrichissement géographique si applicable
  if [zone] {
    mutate {
      add_field => {
        "floor" => "unknown"
      }
    }
    
    # Mapper les zones aux étages
    if [zone] =~ /^(A|B|C)/ {
      mutate { update => { "floor" => "1" } }
    } else if [zone] =~ /^(D|E|F)/ {
      mutate { update => { "floor" => "2" } }
    } else if [zone] =~ /^(G|H|I)/ {
      mutate { update => { "floor" => "3" } }
    }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "logs-iot-alerts-%{+YYYY.MM.dd}"
    action => "create"
  }

  stdout {
    codec => rubydebug
  }
}
