{% extends "base.html" %}

{% block title %}{{ 'Modifier' if mode == 'edit' else 'Cr√©er' }} R√®gle - IoT Smart Building{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('alerts.index') }}">Alertes</a></li>
                <li class="breadcrumb-item active">{{ 'Modifier' if mode == 'edit' else 'Cr√©er' }} R√®gle</li>
            </ol>
        </nav>
        <h1 class="h3">
            <i class="fas fa-{{ 'edit' if mode == 'edit' else 'plus' }} text-primary me-2"></i>
            {{ 'Modifier la r√®gle' if mode == 'edit' else 'Nouvelle r√®gle d\'alerte' }}
        </h1>
    </div>
    
    <form method="POST" id="ruleForm">
        <div class="row g-4">
            <!-- Left Column: Basic Info -->
            <div class="col-lg-8">
                <!-- Basic Info Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Informations de base
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label">Nom de la r√®gle <span class="text-danger">*</span></label>
                                <input type="text" name="name" class="form-control" required
                                       value="{{ rule.name if rule else '' }}"
                                       placeholder="Ex: Temp√©rature critique Zone A">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">S√©v√©rit√© <span class="text-danger">*</span></label>
                                <select name="severity" class="form-select" required>
                                    <option value="low" {{ 'selected' if rule and rule.severity == 'low' else '' }}>
                                        üü¢ Low
                                    </option>
                                    <option value="medium" {{ 'selected' if rule and rule.severity == 'medium' else '' }}>
                                        üü° Medium
                                    </option>
                                    <option value="high" {{ 'selected' if rule and rule.severity == 'high' else '' }}>
                                        üü† High
                                    </option>
                                    <option value="critical" {{ 'selected' if rule and rule.severity == 'critical' else '' }}>
                                        üî¥ Critical
                                    </option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <textarea name="description" class="form-control" rows="2"
                                          placeholder="Description optionnelle de la r√®gle">{{ rule.description if rule else '' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Condition Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-code me-2"></i>
                            Condition de d√©clenchement
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Type de r√®gle <span class="text-danger">*</span></label>
                                <select name="rule_type" class="form-select" id="ruleType" required>
                                    <option value="threshold" {{ 'selected' if not rule or rule.rule_type == 'threshold' else '' }}>
                                        Seuil (Threshold)
                                    </option>
                                    <option value="range" {{ 'selected' if rule and rule.rule_type == 'range' else '' }}>
                                        Plage (Range)
                                    </option>
                                    <option value="pattern" {{ 'selected' if rule and rule.rule_type == 'pattern' else '' }}>
                                        Pattern (Comptage)
                                    </option>
                                </select>
                            </div>
                            
                            <!-- Threshold Conditions -->
                            <div class="col-md-8 threshold-fields">
                                <div class="row g-2">
                                    <div class="col-4">
                                        <label class="form-label">Champ</label>
                                        <select name="condition_field" class="form-select">
                                            <option value="value" {{ 'selected' if not rule or rule.conditions.get('field') == 'value' else '' }}>value</option>
                                            <option value="status" {{ 'selected' if rule and rule.conditions.get('field') == 'status' else '' }}>status</option>
                                        </select>
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">Op√©rateur</label>
                                        <select name="condition_operator" class="form-select">
                                            <option value=">" {{ 'selected' if not rule or rule.conditions.get('operator') == '>' else '' }}>&gt; (sup√©rieur)</option>
                                            <option value="<" {{ 'selected' if rule and rule.conditions.get('operator') == '<' else '' }}>&lt; (inf√©rieur)</option>
                                            <option value=">=" {{ 'selected' if rule and rule.conditions.get('operator') == '>=' else '' }}>&gt;= (sup. ou √©gal)</option>
                                            <option value="<=" {{ 'selected' if rule and rule.conditions.get('operator') == '<=' else '' }}>&lt;= (inf. ou √©gal)</option>
                                            <option value="==" {{ 'selected' if rule and rule.conditions.get('operator') == '==' else '' }}>== (√©gal)</option>
                                            <option value="!=" {{ 'selected' if rule and rule.conditions.get('operator') == '!=' else '' }}>!= (diff√©rent)</option>
                                        </select>
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">Seuil</label>
                                        <input type="number" name="condition_threshold" class="form-control" step="any"
                                               value="{{ rule.conditions.threshold if rule and rule.conditions else 30 }}">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Range Conditions (hidden by default) -->
                            <div class="col-md-8 range-fields" style="display: none;">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label class="form-label">Valeur minimale</label>
                                        <input type="number" name="range_min" class="form-control" step="any"
                                               value="{{ rule.conditions.min_value if rule and rule.conditions else 15 }}">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Valeur maximale</label>
                                        <input type="number" name="range_max" class="form-control" step="any"
                                               value="{{ rule.conditions.max_value if rule and rule.conditions else 30 }}">
                                    </div>
                                </div>
                                <small class="text-muted">L'alerte se d√©clenche si la valeur est HORS de cette plage</small>
                            </div>
                            
                            <!-- Pattern Conditions (hidden by default) -->
                            <div class="col-md-8 pattern-fields" style="display: none;">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label class="form-label">Nombre minimum d'√©v√©nements</label>
                                        <input type="number" name="pattern_count" class="form-control" min="1"
                                               value="{{ rule.conditions.min_count if rule and rule.conditions else 3 }}">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Fen√™tre de temps (secondes)</label>
                                        <input type="number" name="pattern_window" class="form-control" min="60"
                                               value="{{ rule.conditions.time_window_seconds if rule and rule.conditions else 300 }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Filters Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-filter me-2"></i>
                            Filtres (optionnel)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Zone</label>
                                <select name="filter_zone" class="form-select">
                                    <option value="">Toutes les zones</option>
                                    {% for zone in ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I'] %}
                                    <option value="{{ zone }}" {{ 'selected' if rule and rule.filters and rule.filters.get('zone') == zone else '' }}>
                                        Zone {{ zone }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Type de capteur</label>
                                <select name="filter_sensor_type" class="form-select">
                                    <option value="">Tous les types</option>
                                    {% for type in ['temperature', 'humidity', 'co2', 'luminosity'] %}
                                    <option value="{{ type }}" {{ 'selected' if rule and rule.filters and rule.filters.get('sensor_type') == type else '' }}>
                                        {{ type | capitalize }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">B√¢timent</label>
                                <input type="text" name="filter_building" class="form-control"
                                       value="{{ rule.filters.building if rule and rule.filters else 'Smart Building A' }}"
                                       placeholder="Smart Building A">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Actions Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-paper-plane me-2"></i>
                            Actions de notification
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Email Action -->
                            <div class="col-12">
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" name="action_email" id="actionEmail"
                                           {% if rule and rule.actions %}{% for a in rule.actions %}{% if a.type == 'email' %}checked{% endif %}{% endfor %}{% endif %}>
                                    <label class="form-check-label" for="actionEmail">
                                        <i class="fas fa-envelope me-2"></i>Notification Email
                                    </label>
                                </div>
                                <div class="email-config ms-4" style="display: none;">
                                    <input type="text" name="email_recipients" class="form-control form-control-sm"
                                           placeholder="email1@example.com, email2@example.com"
                                           value="{% if rule and rule.actions %}{% for a in rule.actions %}{% if a.type == 'email' %}{{ a.config.recipients | join(', ') }}{% endif %}{% endfor %}{% endif %}">
                                    <small class="text-muted">S√©parez les adresses par des virgules</small>
                                </div>
                            </div>
                            
                            <!-- Webhook Action -->
                            <div class="col-12">
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" name="action_webhook" id="actionWebhook"
                                           {% if rule and rule.actions %}{% for a in rule.actions %}{% if a.type == 'webhook' %}checked{% endif %}{% endfor %}{% endif %}>
                                    <label class="form-check-label" for="actionWebhook">
                                        <i class="fas fa-globe me-2"></i>Webhook personnalis√©
                                    </label>
                                </div>
                                <div class="webhook-config ms-4" style="display: none;">
                                    <input type="url" name="webhook_url" class="form-control form-control-sm"
                                           placeholder="https://your-webhook-url.com/endpoint"
                                           value="{% if rule and rule.actions %}{% for a in rule.actions %}{% if a.type == 'webhook' %}{{ a.config.url }}{% endif %}{% endfor %}{% endif %}">
                                </div>
                            </div>
                            
                            <!-- Slack Action -->
                            <div class="col-12">
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" name="action_slack" id="actionSlack"
                                           {% if rule and rule.actions %}{% for a in rule.actions %}{% if a.type == 'slack' %}checked{% endif %}{% endfor %}{% endif %}>
                                    <label class="form-check-label" for="actionSlack">
                                        <i class="fab fa-slack me-2"></i>Slack
                                    </label>
                                </div>
                                <div class="slack-config ms-4" style="display: none;">
                                    <input type="url" name="slack_webhook_url" class="form-control form-control-sm"
                                           placeholder="https://hooks.slack.com/services/..."
                                           value="{% if rule and rule.actions %}{% for a in rule.actions %}{% if a.type == 'slack' %}{{ a.config.webhook_url }}{% endif %}{% endfor %}{% endif %}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Settings & Submit -->
            <div class="col-lg-4">
                <!-- Settings Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-cog me-2"></i>
                            Param√®tres
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="enabled" id="ruleEnabled"
                                       {{ 'checked' if not rule or rule.enabled else '' }}>
                                <label class="form-check-label" for="ruleEnabled">
                                    R√®gle active
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cooldown (secondes)</label>
                            <input type="number" name="cooldown" class="form-control" min="60" max="86400"
                                   value="{{ rule.cooldown_seconds if rule else 300 }}">
                            <small class="text-muted">Temps minimum entre deux alertes</small>
                        </div>
                    </div>
                </div>
                
                <!-- Stats Card (Edit mode only) -->
                {% if mode == 'edit' and rule %}
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Statistiques
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>D√©clenchements:</span>
                            <strong>{{ rule.trigger_count or 0 }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Dernier d√©clenchement:</span>
                            <strong>{{ rule.last_triggered.strftime('%d/%m/%Y %H:%M') if rule.last_triggered else 'Jamais' }}</strong>
                        </div>
                        {% if rule.stats and rule.stats.zones_affected %}
                        <div class="d-flex justify-content-between mb-2">
                            <span>Zones affect√©es:</span>
                            <strong>{{ rule.stats.zones_affected | join(', ') }}</strong>
                        </div>
                        {% endif %}
                        {% if rule.stats and rule.stats.avg_value_on_trigger %}
                        <div class="d-flex justify-content-between">
                            <span>Valeur moyenne:</span>
                            <strong>{{ '%.2f' | format(rule.stats.avg_value_on_trigger) }}</strong>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Submit Card -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-{{ 'save' if mode == 'edit' else 'plus' }} me-2"></i>
                                {{ 'Enregistrer les modifications' if mode == 'edit' else 'Cr√©er la r√®gle' }}
                            </button>
                            <a href="{{ url_for('alerts.index') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Annuler
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle rule type fields
    const ruleType = document.getElementById('ruleType');
    const thresholdFields = document.querySelector('.threshold-fields');
    const rangeFields = document.querySelector('.range-fields');
    const patternFields = document.querySelector('.pattern-fields');
    
    function updateFieldVisibility() {
        const type = ruleType.value;
        thresholdFields.style.display = type === 'threshold' ? '' : 'none';
        rangeFields.style.display = type === 'range' ? '' : 'none';
        patternFields.style.display = type === 'pattern' ? '' : 'none';
    }
    
    ruleType.addEventListener('change', updateFieldVisibility);
    updateFieldVisibility();
    
    // Toggle action config visibility
    function setupActionToggle(checkboxId, configClass) {
        const checkbox = document.getElementById(checkboxId);
        const config = document.querySelector('.' + configClass);
        
        if (checkbox && config) {
            checkbox.addEventListener('change', function() {
                config.style.display = this.checked ? '' : 'none';
            });
            // Initial state
            config.style.display = checkbox.checked ? '' : 'none';
        }
    }
    
    setupActionToggle('actionEmail', 'email-config');
    setupActionToggle('actionWebhook', 'webhook-config');
    setupActionToggle('actionSlack', 'slack-config');
});
</script>
{% endblock %}
