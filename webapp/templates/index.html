{% extends "base.html" %}

{% block content %}
<div class="container">
    <!-- En-tête -->
    <div class="row mb-4">
        <div class="col">
            <h1><i class="bi bi-speedometer2"></i> Dashboard IoT Smart Building</h1>
            <p class="text-muted">Vue d'ensemble en temps réel des capteurs et alertes</p>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="row mb-4" id="kpi-cards">
        <div class="col-md-3 mb-3">
            <div class="card border-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-0">Total Logs</h6>
                            <h2 class="mb-0" id="total-logs">
                                <span class="spinner-border spinner-border-sm"></span>
                            </h2>
                        </div>
                        <div class="fs-1 text-primary">
                            <i class="bi bi-database"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-0">Logs Aujourd'hui</h6>
                            <h2 class="mb-0" id="logs-today">
                                <span class="spinner-border spinner-border-sm"></span>
                            </h2>
                        </div>
                        <div class="fs-1 text-success">
                            <i class="bi bi-clock-history"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-danger">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-0">Alertes Critiques</h6>
                            <h2 class="mb-0" id="errors-count">
                                <span class="spinner-border spinner-border-sm"></span>
                            </h2>
                        </div>
                        <div class="fs-1 text-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-0">Fichiers Uploadés</h6>
                            <h2 class="mb-0" id="files-uploaded">
                                <span class="spinner-border spinner-border-sm"></span>
                            </h2>
                        </div>
                        <div class="fs-1 text-info">
                            <i class="bi bi-file-earmark-text"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphiques -->
    <div class="row mb-4">
        <div class="col-md-8 mb-3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Évolution des Logs (7 derniers jours)</h5>
                </div>
                <div class="card-body">
                    <canvas id="logsChart" height="80"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-3">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Types de Capteurs</h5>
                </div>
                <div class="card-body">
                    <canvas id="sensorsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Derniers logs -->
    </div>
    </div>

    <!-- ========== SECTION TEMPS RÉEL (WebSocket) ========== -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-broadcast-pin"></i> Flux Temps Réel
                        <span id="realtime-status" class="badge bg-light text-dark ms-2">
                            <span class="spinner-border spinner-border-sm"></span> Initialisation...
                        </span>
                        <span id="new-logs-count" class="badge bg-warning ms-2 d-none">+0</span>
                    </h5>
                    <small id="last-update" class="text-light">En attente...</small>
                </div>
                <div class="card-body">
                    <!-- Alertes critiques -->
                    <div id="alerts-container" class="mb-3"></div>
                    
                    <!-- Tableau temps réel -->
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th width="15%">Heure</th>
                                    <th width="10%">Zone</th>
                                    <th width="30%">Type/Message</th>
                                    <th width="20%">Valeur</th>
                                    <th width="15%">Statut</th>
                                </tr>
                            </thead>
                            <tbody id="realtime-logs-tbody">
                                <tr>
                                    <td colspan="5" class="text-center text-muted">
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                        Connexion au flux temps réel...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ========== FIN SECTION TEMPS RÉEL ========== -->

    <!-- Activité par zone (24 dernières heures) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Activité par Zone (24 dernières heures)</h5>
                </div>
                <div class="card-body">
                    <div id="zones-activity">
                        <p class="text-muted text-center">
                            <span class="spinner-border spinner-border-sm"></span> Chargement...
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphiques -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-list-ul"></i> Derniers Logs</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm" id="recent-logs-table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Zone</th>
                                    <th>Type Capteur</th>
                                    <th>Valeur</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <span class="spinner-border spinner-border-sm"></span>
                                        Chargement des données...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Charger les statistiques au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardStats();
    loadRecentLogs();
    loadZonesActivity();
    initCharts();
    
    // Rafraîchir toutes les 30 secondes (sauf si WebSocket actif)
    setInterval(() => {
        loadDashboardStats();
        loadRecentLogs();
        loadZonesActivity();
    }, 30000);
});

// Charger les statistiques depuis l'API
async function loadDashboardStats() {
    try {
        const response = await fetch('/api/v1/stats');
        const data = await response.json();
        
        // Mettre à jour les KPI
        document.getElementById('total-logs').textContent = data.total_logs.toLocaleString();
        document.getElementById('logs-today').textContent = data.logs_today.toLocaleString();
        document.getElementById('errors-count').textContent = data.errors_count.toLocaleString();
        document.getElementById('files-uploaded').textContent = data.files_uploaded.toLocaleString();
        
    } catch (error) {
        console.error('Erreur lors du chargement des stats:', error);
    }
}

// Charger les derniers logs
async function loadRecentLogs() {
    try {
        const response = await fetch('/api/v1/logs?per_page=10&page=1');
        const data = await response.json();
        
        const tbody = document.querySelector('#recent-logs-table tbody');
        if (!tbody) return;
        
        if (data.logs && data.logs.length > 0) {
            tbody.innerHTML = data.logs.map(log => {
                const statusBadge = getStatusBadge(log.status || log.severity);
                const timestamp = new Date(log.timestamp || log['@timestamp']).toLocaleString('fr-FR');
                
                return `
                    <tr>
                        <td><small>${timestamp}</small></td>
                        <td><span class="badge bg-secondary">${log.zone || 'N/A'}</span></td>
                        <td>${log.sensor_type || log.event_type || 'N/A'}</td>
                        <td>${log.value || ''} ${log.unit || ''}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            }).join('');
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted">
                        <i class="bi bi-inbox"></i> Aucun log disponible
                    </td>
                </tr>
            `;
        }
    } catch (error) {
        console.error('Erreur lors du chargement des logs:', error);
        const tbody = document.querySelector('#recent-logs-table tbody');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-danger">
                        <i class="bi bi-exclamation-triangle"></i> Erreur de chargement
                    </td>
                </tr>
            `;
        }
    }
}

// Charger l'activité par zone
async function loadZonesActivity() {
    try {
        // Utiliser l'API de recherche avec une agrégation sur les zones
        const response = await fetch('/api/v1/logs?per_page=0');
        const data = await response.json();
        
        // Compter les logs par zone manuellement ou utiliser une requête ES directe
        // Pour simplifier, on va afficher un message ou charger via WebSocket
        const container = document.getElementById('zones-activity');
        if (!container) return;
        
        // Si pas de données zones dans l'API, afficher message
        if (!data.zones_activity) {
            container.innerHTML = `
                <p class="text-muted text-center">
                    <i class="bi bi-info-circle"></i> Connectez-vous au monitoring temps réel pour voir l'activité des zones
                </p>
            `;
        }
    } catch (error) {
        console.error('Erreur lors du chargement de l\'activité zones:', error);
    }
}

// Fonction helper pour les badges de statut
function getStatusBadge(status) {
    const badges = {
        'ok': '<span class="badge bg-success">OK</span>',
        'warning': '<span class="badge bg-warning">Warning</span>',
        'error': '<span class="badge bg-danger">Error</span>',
        'critical': '<span class="badge bg-danger"><i class="bi bi-exclamation-triangle-fill"></i> Critical</span>',
        'high': '<span class="badge bg-warning">High</span>',
        'medium': '<span class="badge bg-info">Medium</span>',
        'low': '<span class="badge bg-secondary">Low</span>',
        'info': '<span class="badge bg-info">Info</span>'
    };
    return badges[status] || `<span class="badge bg-secondary">${status || 'N/A'}</span>`;
}

// Initialiser les graphiques Chart.js
function initCharts() {
    // Graphique d'évolution des logs
    const logsCtx = document.getElementById('logsChart').getContext('2d');
    const logsChart = new Chart(logsCtx, {
        type: 'line',
        data: {
            labels: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
            datasets: [{
                label: 'Nombre de logs',
                data: [0, 0, 0, 0, 0, 0, 0],
                borderColor: 'rgb(13, 110, 253)',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Graphique des types de capteurs
    const sensorsCtx = document.getElementById('sensorsChart').getContext('2d');
    const sensorsChart = new Chart(sensorsCtx, {
        type: 'doughnut',
        data: {
            labels: ['Température', 'Humidité', 'Luminosité', 'CO2'],
            datasets: [{
                data: [0, 0, 0, 0],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 206, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true
        }
    });
}
</script>

<!-- Socket.IO pour WebSocket temps réel -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="{{ url_for('static', filename='js/realtime.js') }}"></script>

<style>
/* Animations pour temps réel */
.number-change {
    animation: pulse 0.5s ease-in-out;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); color: #0d6efd; }
}

.pulse-animation {
    animation: card-pulse 1s ease-in-out;
}

@keyframes card-pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0); }
    50% { box-shadow: 0 0 20px 5px rgba(13, 110, 253, 0.5); }
}

.fade-in {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}
